<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pokémon fit お迎えチェックリスト</title>
  <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
</head>
<body>
  <div id="app" class="m-5">
    <h1 class="font-bold mb-5 text-xl">Pokémon fit お迎えチェックリスト</h1>

    <ul class="space-y-4 text-left text-gray-800 mb-5 text-xs">
      <li class="flex items-center space-x-3 rtl:space-x-reverse">
        <svg class="shrink-0 w-3.5 h-3.5 text-green-500 dark:text-green-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 12">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5.917 5.724 10.5 15 1.5"/>
        </svg>
        <span>チェック状態はこのブラウザに保存されます。キャッシュ削除するとリセットされます</span>
      </li>
      <li class="flex items-center space-x-3 rtl:space-x-reverse">
        <svg class="shrink-0 w-3.5 h-3.5 text-green-500 dark:text-green-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 12">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5.917 5.724 10.5 15 1.5"/>
        </svg>
        <span>このページは非公式です。実際の商品情報が異なる可能性があります</span>
      </li>
    </ul>

    <div class="mb-5 text-sm font-medium text-gray-900">表示する地方</div>

    <ul class="items-center w-full text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg sm:flex dark:bg-gray-700 dark:border-gray-600 dark:text-white mb-5">
      <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="kanto-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="カントー" checked>
          <label for="kanto-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">カントー</label>
        </div>
      </li>
      <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="johto-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="ジョウト" checked>
          <label for="johto-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">ジョウト</label>
        </div>
      </li>
      <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="hoenn-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="ホウエン" checked>
          <label for="hoenn-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">ホウエン</label>
        </div>
      </li>
      <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="sinnoh-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="シンオウ" checked>
          <label for="sinnoh-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">シンオウ</label>
        </div>
      </li>
      <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="unova-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-600 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="イッシュ" checked>
          <label for="unova-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">イッシュ</label>
        </div>
      </li>
      <li class="w-full dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="kalos-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="カロス" checked>
          <label for="kalos-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">カロス</label>
        </div>
      </li>
    </ul>

    <div id="currentCount" class="mb-5 text-sm font-medium text-gray-900"></div>

    <div class="relative overflow-x-auto sm:rounded-lg">
      <table id="csvTable" class="table-fixed w-full text-sm text-center rtl:text-right text-gray-800 dark:text-white">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-white">
          <tr>
            <th scope="col" class="py-5 w-20">お迎え</th>
            <th scope="col" class="w-20">図鑑番号</th>
            <th scope="col" class="">名前</th>
            <th scope="col" class="">地方</th>
          </tr>
        </thead>
        <tbody>
          <tr id="headerRow"></tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const csvUrl = 'https://raw.githubusercontent.com/addshlab/poke-source/main/csv/pokemon_fit_list.csv';
      const areaFilters = document.querySelectorAll('.areaFilter');

      // ローカルストレージからデータを取得
      let savedData = JSON.parse(localStorage.getItem('pokemon_fit_list')) || { checked: "", area: ["カントー", "ジョウト", "ホウエン", "シンオウ", "イッシュ", "カロス"], lineLength: 0 };

      // フィルタチェックボックスの状態を復元
      areaFilters.forEach(filter => {
        filter.checked = savedData.area.includes(filter.value);
      });

      fetch(csvUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.statusText}`);
          }
          return response.text();
        })
        .then(contents => {
          const rows = contents.split('\n').filter(row => row.trim() !== "");
          // ヘッダー行を除外してデータ行のみを取得
          const dataRows = rows.slice(1);
          const tableBody = document.querySelector('#csvTable tbody');
          const headerRow = document.getElementById('headerRow');
          tableBody.innerHTML = '';
          headerRow.innerHTML = '';

          const newDataLength = dataRows.length;

          // lineLengthが未設定または新たな行数が既存より多い場合に対応
          if (savedData.lineLength < newDataLength) {
            const missingCount = newDataLength - savedData.lineLength;
            savedData.checked = savedData.checked + "0".repeat(missingCount);
            savedData.lineLength = newDataLength;
            localStorage.setItem('pokemon_fit_list', JSON.stringify(savedData));
          }

          // データ行に対してチェック状態を設定し、テーブルを生成
          dataRows.forEach((row, index) => {
            const cells = row.split(',');
            const tr = document.createElement('tr');
            const tdCheckbox = document.createElement('td');
            const checkbox = document.createElement('input');

            tr.classList.add("bg-white", "border-b", "dark:bg-gray-800", "dark:border-gray-700", "border-gray-200", "hover:bg-gray-50", "dark:hover:bg-gray-600", "text-center");
            tdCheckbox.classList.add("px-6", "py-4");
            checkbox.classList.add("w-4", "h-4", "text-blue-600", "bg-gray-100", "border-gray-300", "rounded-sm", "focus:ring-blue-500", "dark:focus:ring-blue-600", "dark:ring-offset-gray-800", "dark:focus:ring-offset-gray-800", "focus:ring-2", "dark:bg-gray-700", "dark:border-gray-600", "text-center");

            checkbox.type = 'checkbox';

            // 保存されたチェック状態の文字列から状態を復元（'1'ならチェック済み）
            if (savedData.checked.charAt(index) === '1') {
              checkbox.checked = true;
            }

            checkbox.addEventListener('change', function() {
              let checkArray = savedData.checked.split("");
              checkArray[index] = this.checked ? "1" : "0";
              savedData.checked = checkArray.join("");
              localStorage.setItem('pokemon_fit_list', JSON.stringify(savedData));
              updateTotalCount();
              updateAreaCounts();
            });

            tdCheckbox.appendChild(checkbox);
            tr.appendChild(tdCheckbox);

            cells.forEach((cell, cellIndex) => {
              // '名前'列をリンクとして表示（'code' をリンクに利用）
              if (cellIndex === 2) {
                const td = document.createElement('td');
                const link = document.createElement('a');
                link.href = `https://www.pokemoncenter-online.com/${cells[4]}.html`;
                link.target = '_blank';
                link.textContent = cell;
                td.appendChild(link);
                tr.appendChild(td);
              } else if (cellIndex !== 0 && cellIndex !== 4) {
                const td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
              }
            });

            tableBody.appendChild(tr);
          });

          // チェック済み総数の更新
          function updateTotalCount() {
            let count = 0;
            Array.from(tableBody.rows).forEach(row => {
              const checkbox = row.querySelector('input[type="checkbox"]');
              if (checkbox && checkbox.checked) {
                count++;
              }
            });
            document.getElementById('currentCount').textContent = 'お迎えした総数: ' + count;
          }

          // 各エリアのチェック数の更新
          function updateAreaCounts() {
            const areaCounts = {};
            areaFilters.forEach(filter => {
              areaCounts[filter.value] = 0;
            });
            Array.from(tableBody.rows).forEach(row => {
              const rowCheckbox = row.querySelector('input[type="checkbox"]');
              if (rowCheckbox && rowCheckbox.checked) {
                const areaCell = row.cells[3];
                if (areaCell) {
                  const areaName = areaCell.textContent.trim();
                  areaCounts[areaName] = (areaCounts[areaName] || 0) + 1;
                }
              }
            });
            areaFilters.forEach(filter => {
              const label = document.querySelector('label[for="' + filter.id + '"]');
              if (label) {
                label.textContent = `${filter.value}(${areaCounts[filter.value] || 0})`;
              }
            });
          }

          // フィルタ処理
          areaFilters.forEach(filter => {
            filter.addEventListener('change', function() {
              const selectedAreas = Array.from(areaFilters)
                .filter(filter => filter.checked)
                .map(filter => filter.value);
              savedData.area = selectedAreas;
              localStorage.setItem('pokemon_fit_list', JSON.stringify(savedData));
              filterTable();
            });
          });

          function filterTable() {
            const selectedAreas = savedData.area;
            if (selectedAreas.length === 0) {
              Array.from(tableBody.rows).forEach(row => {
                row.style.display = 'none';
              });
            } else {
              Array.from(tableBody.rows).forEach(row => {
                const areaCell = row.cells[3];
                row.style.display = (areaCell && selectedAreas.includes(areaCell.textContent.trim())) ? '' : 'none';
              });
            }
            updateTotalCount();
            updateAreaCounts();
          }

          filterTable();
          updateTotalCount();
          updateAreaCounts();
        })
        .catch(error => {
          console.error('CSVの読み込み中にエラーが発生しました:', error);
        });
    });
  </script>
</body>
</html>
