<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pokémon fitチェックリスト</title>
  <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
</head>
<body>
  <div id="app" class="m-5">
    <h1 class="font-bold mb-5 text-xl">Pokémon fit お迎えチェックリスト</h1>

    <ul class="space-y-4 text-left text-gray-700 dark:text-gray-400 mb-5 text-xs">
      <li class="flex items-center space-x-3 rtl:space-x-reverse">
        <svg class="shrink-0 w-3.5 h-3.5 text-green-500 dark:text-green-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 12">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5.917 5.724 10.5 15 1.5"/>
        </svg>
        <span>チェック状態はこのブラウザに保存されます。状態の永続は保証しません</span>
      </li>
      <li class="flex items-center space-x-3 rtl:space-x-reverse">
        <svg class="shrink-0 w-3.5 h-3.5 text-green-500 dark:text-green-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 12">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5.917 5.724 10.5 15 1.5"/>
        </svg>
        <span>このページは非公式です。実際の商品情報が異なる可能性があります</span>
      </li>
      <li class="flex items-center space-x-3 rtl:space-x-reverse">
        <svg class="shrink-0 w-3.5 h-3.5 text-green-500 dark:text-green-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 12">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 5.917 5.724 10.5 15 1.5"/>
        </svg>
        <span>「黒いレックウザ」はホウエン地方の最後にあります</span>
      </li>
    </ul>

    <ul class="items-center w-full text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg sm:flex dark:bg-gray-700 dark:border-gray-600 dark:text-white mb-5">
      <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="kanto-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="カントー" checked>
          <label for="kanto-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">カントー</label>
        </div>
      </li>
      <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="johto-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="ジョウト" checked>
          <label for="johto-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">ジョウト</label>
        </div>
      </li>
      <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="hoenn-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="ホウエン" checked>
          <label for="hoenn-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">ホウエン</label>
        </div>
      </li>
      <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="sinnoh-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="シンオウ" checked>
          <label for="sinnoh-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">シンオウ</label>
        </div>
      </li>
      <li class="w-full border-b border-gray-200 sm:border-b-0 sm:border-r dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="unova-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-600 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="イッシュ" checked>
          <label for="unova-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">イッシュ</label>
        </div>
      </li>
      <li class="w-full dark:border-gray-600">
        <div class="flex items-center ps-3">
          <input id="kalos-checkbox-list" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500 areaFilter" value="カロス" checked>
          <label for="kalos-checkbox-list" class="w-full py-3 ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">カロス</label>
        </div>
      </li>
    </ul>

    <!-- 変更: エリア選択欄の下にお迎えした総数を表示 -->
    <div id="currentCount" class="mb-5 text-sm font-medium text-gray-900"></div>

    <div class="relative overflow-x-auto sm:rounded-lg">
      <table id="csvTable" class="w-full text-sm text-center rtl:text-right text-gray-800 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
          <tr>
            <th scope="col" class="p-4 w-10">お迎え</th>
            <th scope="col" class="px-6 py-3 w-25">図鑑番号</th>
            <th scope="col" class="px-6 py-3">名前</th>
            <th scope="col" class="px-6 py-3">地方</th>
          </tr>
        </thead>
        <tbody>
          <tr id="headerRow"></tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const csvUrl = 'https://raw.githubusercontent.com/addshlab/poke-source/main/csv/pokemon_fit_list.csv';
      const areaFilters = document.querySelectorAll('.areaFilter');

      // ローカルストレージのデータを取得
      let savedData = JSON.parse(localStorage.getItem('pokemon_fit_list')) || { checked: [], area: ["カントー", "ジョウト", "ホウエン", "シンオウ", "イッシュ", "カロス"] };

      // フィルタチェックボックスの状態をローカルストレージから復元
      areaFilters.forEach(filter => {
        filter.checked = savedData.area.includes(filter.value);
      });

      fetch(csvUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.statusText}`);
          }
          return response.text();
        })
        .then(contents => {
          const rows = contents.split('\n').filter(row => row.trim() !== ""); // 空行を除外
          const tableBody = document.querySelector('#csvTable tbody');
          const headerRow = document.getElementById('headerRow');
          tableBody.innerHTML = '';
          headerRow.innerHTML = '';

          rows.forEach((row, index) => {
            const cells = row.split(',');
            // データ行の作成
            const tr = document.createElement('tr');
            const tdCheckbox = document.createElement('td');
            const checkbox = document.createElement('input');

            tr.classList.add("bg-white", "border-b", "dark:bg-gray-800", "dark:border-gray-700", "border-gray-200", "hover:bg-gray-50", "dark:hover:bg-gray-600", "text-center");
            tdCheckbox.classList.add("px-6", "py-4");
            checkbox.classList.add("w-4", "h-4", "text-blue-600", "bg-gray-100", "border-gray-300", "rounded-sm", "focus:ring-blue-500", "dark:focus:ring-blue-600", "dark:ring-offset-gray-800", "dark:focus:ring-offset-gray-800", "focus:ring-2", "dark:bg-gray-700", "dark:border-gray-600", "text-center");

            checkbox.type = 'checkbox';

            // チェックボックスの状態をローカルストレージから復元
            const uniqueKey = `${cells[0]}_${cells[3]}`; // {number}_{code}の形式
            if (savedData.checked.includes(uniqueKey)) {
              checkbox.checked = true;
            }

            checkbox.addEventListener('change', function() {
              let checkedRows = savedData.checked;
              if (this.checked) {
                checkedRows.push(uniqueKey);
              } else {
                checkedRows = checkedRows.filter(key => key !== uniqueKey);
              }
              savedData.checked = checkedRows;
              localStorage.setItem('pokemon_fit_list', JSON.stringify(savedData));
              updateTotalCount();
              updateAreaCounts();
            });

            tdCheckbox.appendChild(checkbox);
            tr.appendChild(tdCheckbox);

            cells.forEach((cell, cellIndex) => {
              if (cellIndex === 1) { // '名前'列としてリンク表示
                const td = document.createElement('td');
                const link = document.createElement('a');
                link.href = `https://www.pokemoncenter-online.com/${cells[3]}.html`; // 'code'をリンクに使用
                link.target = '_blank';
                link.textContent = cell;
                td.appendChild(link);
                tr.appendChild(td);
              } else if (cellIndex !== 3 && cellIndex !== 4) { // 'code'と'price'列を除外
                const td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
              }
            });

            tableBody.appendChild(tr);
          });

          // お迎えした総数（フィルタ状態に関係なく全体のチェック済み件数）を更新する関数
          function updateTotalCount() {
            let count = 0;
            // 全ての行を対象にチェックされた件数を集計
            Array.from(tableBody.rows).forEach(row => {
              const checkbox = row.querySelector('input[type="checkbox"]');
              if (checkbox && checkbox.checked) {
                count++;
              }
            });
            document.getElementById('currentCount').textContent = 'お迎えした総数: ' + count;
          }

          // 各エリアのチェックボックスラベルに表示する「お迎え数」を更新する関数
          function updateAreaCounts() {
            // 初期化: 各エリアの件数を0に設定
            const areaCounts = {};
            areaFilters.forEach(filter => {
              areaCounts[filter.value] = 0;
            });
            // 各行を走査して、チェックが入っている行のエリア毎にカウント
            Array.from(tableBody.rows).forEach(row => {
              const rowCheckbox = row.querySelector('input[type="checkbox"]');
              if (rowCheckbox && rowCheckbox.checked) {
                const areaCell = row.cells[3]; // 「地方」列
                if (areaCell) {
                  const areaName = areaCell.textContent.trim();
                  if (areaCounts.hasOwnProperty(areaName)) {
                    areaCounts[areaName]++;
                  } else {
                    areaCounts[areaName] = 1;
                  }
                }
              }
            });
            // 各エリアのラベルを更新
            areaFilters.forEach(filter => {
              const label = document.querySelector('label[for="' + filter.id + '"]');
              if (label) {
                label.textContent = `${filter.value}(${areaCounts[filter.value] || 0})`;
              }
            });
          }

          // フィルタリング処理を追加
          areaFilters.forEach(filter => {
            filter.addEventListener('change', function() {
              // フィルタの状態を保存
              const selectedAreas = Array.from(areaFilters)
                .filter(filter => filter.checked)
                .map(filter => filter.value);
              savedData.area = selectedAreas;
              localStorage.setItem('pokemon_fit_list', JSON.stringify(savedData));
              filterTable();
            });
          });

          function filterTable() {
            const selectedAreas = savedData.area;
            if (selectedAreas.length === 0) {
              Array.from(tableBody.rows).forEach(row => {
                row.style.display = 'none';
              });
            } else {
              Array.from(tableBody.rows).forEach(row => {
                const areaCell = row.cells[3];
                if (areaCell && !selectedAreas.includes(areaCell.textContent.trim())) {
                  row.style.display = 'none';
                } else {
                  row.style.display = '';
                }
              });
            }
            updateTotalCount();
            updateAreaCounts();
          }

          filterTable();
          updateTotalCount();
          updateAreaCounts();
        })
        .catch(error => {
          console.error('CSVの読み込み中にエラーが発生しました:', error);
        });
    });
  </script>
</body>
</html>
